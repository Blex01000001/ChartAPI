<!DOCTYPE html>
<html lang="en">
<style type="text/css">
    #ChartContainer {
        flex-direction: column;
        display: flex;
        left: 20px;
/*        background-color: #cde2ff;
        border-color: #d90000;
        border-style: dashed;
        border-width: 1px;
*/
    }
    #ChartContainer div {
        margin: 5px;
    }
    #InputArea {
        display: flex;
        padding: 5px;
        gap: 5px;
    }
    .Monthly-Area {
        display: flex;
        background-color: #e4e4e4;
        border-radius: 30px;
        align-items: center; /* 子元素垂直置中 */
        /*
        border-color: #0000d9;
        border-style: dashed;
        border-width: 1px;
        */
        /*width: 100%;*/
        /*/height: 300px;*/
    }

    .MonthLabel {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 100%;
        font-size: 25px;
        font-weight: bold;
        color: #333;
        transform: rotate(270deg);
        /*background-color: #d90000;*/
        border-radius: 8px;
        /*box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);*/
    }

    .PieChartArea {
        /*flex: 1;*/
        width: 450px;
        height: 250px;
/*        border-color: #d90000;
        border-style: dashed;
        border-width: 1px;
*/    }
    
    .StackChartArea {
        /*flex: 1;*/
        width: 400px;
        height: 250px;
/*        border-color: #0000d9;
        border-style: dashed;
        border-width: 1px;
*/    }

</style>

<head>
    <meta charset="UTF-8">
    <title>MonthlyChart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/6.0.0/echarts.min.js"
            integrity="sha512-4/g9GAdOdTpUP2mKClpKsEzaK7FQNgMjq+No0rX8XZlfrCGtbi4r+T/p5fnacsEC3zIAmHKLJUL7sh3/yVA4OQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>

<body>
    <!--<div><button onclick="DrawChart()">圖表繪製</button></div>-->
    <div id="InputArea">
        <input type="text" id="inputYearField" placeholder="年份" style="width: 75px;" list="YearList">
        <datalist id="YearList">
            <option value="2025">
            <option value="2024">
            <option value="2023">
            <option value="2022">
        </datalist>

        <input type="text" id="inputIDField" placeholder="工號" style="width: 75px;">
        <input type="text" id="inputNameField" placeholder="名字" style="width: 75px;" list="idHistory">
        <datalist id="idHistory">
            <option value="李冠旻">
            <option value="林永泰">
            <option value="謝元傑">
            <option value="陳易寬">
        </datalist>
        <div><button onclick="QueryChartData()">Query</button></div>
        <div><button onclick="SaveAsPNG()">Save as PNG</button></div>
        <select id="chartSelector" onchange="Update(this.value)">
            <option value="CostCode">依 CostCode</option>
            <option value="WorkNo">依 WorkNo</option>
        </select>
    </div>
    <div id="ChartContainer"></div> <!-- 主容器放多個 MonthArea -->

</body>

</html>

<script>
    const container = document.getElementById('ChartContainer');
    let re;
    let ChartName;
    let pie;
    const monthDict = {
        1: "January",
        2: "February",
        3: "March",
        4: "April",
        5: "May",
        6: "June",
        7: "July",
        8: "August",
        9: "September",
        10: "October",
        11: "November",
        12: "December"
    };
    function QueryChartData() {
        const QueryID = document.getElementById('inputIDField').value;
        const QueryName = document.getElementById('inputNameField').value;
        let QueryYear = document.getElementById('inputYearField').value;
        ChartName = QueryName + ' Stack Pie Chart'
        console.log(QueryName,QueryYear);
        $.ajax({
            type: "GET",
            url: "http://localhost:5265/api/Chart/GetMonthlyData",
            data: { name: QueryName, year: QueryYear, id: QueryID },
            //dataType: "json",
            success: function (response) {
                console.log('QueryCalendarData success');
                re = response;
                DrawChartData(response);
            },
            error: function (thrownError) {
                console.log('QueryCalendarData error');
                console.log(response);
            }
        });
    }

    function SaveAsPNG() {
        const target = document.getElementById('ChartContainer');
        html2canvas(target, {
            useCORS: true,
            scale: 3  // 提高畫質
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = ChartName + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });    }

    function Update(e) {
        console.log(e);
        
        const pieData = re[0].pieChartDic[e];
        pie.setOption({
            title: {
                text: pieData.title,
            },
            series: [{
                data: pieData.data,
            }],


        });
        console.log('finish');
    }


    function DrawChartData(response) {
        document.querySelectorAll('.Monthly-Area').forEach(el => el.remove());

        response.forEach((monthlyData, index) => {
            // 建立 MonthArea 主容器
            const monthArea = document.createElement('div');

            monthArea.className = 'Monthly-Area';

            // 建立月份標籤
            const monthLabel = document.createElement('div');
            monthLabel.className = 'MonthLabel';
            monthLabel.textContent = monthDict[monthlyData.month];

            // 建立 PieChartArea
            const pieChartDiv = document.createElement('div');
            pieChartDiv.className = 'PieChartArea';

            // 建立 StackChartArea
            const stackChartDiv = document.createElement('div');
            stackChartDiv.className = 'StackChartArea';

            // 建立 PieChartArea
            const pieChartDiv2 = document.createElement('div');
            pieChartDiv2.className = 'PieChartArea';


            // 插入子元素
            monthArea.appendChild(monthLabel);
            monthArea.appendChild(pieChartDiv);
            monthArea.appendChild(stackChartDiv);
            monthArea.appendChild(pieChartDiv2);

            // 插入到頁面主容器
            container.appendChild(monthArea);

            // 初始化圖表（這邊你需用你的 pieData 與 stackData 實作）
            pie = echarts.init(pieChartDiv);
            const pieChart2 = echarts.init(pieChartDiv2);
            const stackChart = echarts.init(stackChartDiv);
            
            //const pieData = monthlyData.pieChart;
            const pieData = monthlyData.pieChartDic["WorkNo"];
            //console.log(monthlyData.pieChartDic["CostCode"]);

            pie.setOption({
                // 建立 pieData 的 option
                title: {
                    show: true,
                    text: pieData.title,
                    top:'2%',
                    textStyle: {
                        fontSize: 14,
                        color: 'rgb(0, 0, 0)',
                        fontFamily: '微軟正黑體'
                    },
                    //subtext: 'subtext',
                    subtextStyle: {
                        fontSize: 16,
                        color: 'rgb(120, 120, 120)',
                        fontFamily: 'Arial'
                    }
                },
                tooltip: { trigger: 'item' },
                series: [{
                    name: 'name',
                    type: 'pie',
                    radius: ['20%', '45%'],
                    center: ['50%', '55%'], // [水平位置, 垂直位置]
                    data: pieData.data,
                    label: {
                        show: true,
                        formatter: '{b}\n{c}({d}%)',
                        fontSize: 14
                    },
                    /*emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }*/
                }],

            });

            const stackData = monthlyData.stackChart;
            stackChart.setOption({
                // 建立 stackData 的 option
                grid: {
                    top: '15%',
                    bottom: '15%',
                    left: '10%',
                    right: '10%'
                },
                title: {
                    show: false,
                    text: stackData.name
                },
                toolbox: { show:false },
                tooltip: {
                    show: false
                },
                legend: {
                    top: '5%'
                },
                xAxis: {
                    type: 'value',
                    name: 'Hours',
                    nameLocation: 'center',
                    nameTextStyle: {
                        fontStyle: 'normal',
                        fontWeight: 'normal',
                        fontFamily: 'Arial',
                        fontSize: 16,
                        color: '#404040',

                    },
                    axisLine: {
                        show: false,
                        lineStyle: {
                            color: '#b0b0b0',
                            width: 1,
                            type: 'solid'
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#c0c0c0',
                            width: 1,
                            type: 'solid'
                        }
                    },
                    axisLabel: {
                        show: true,
                        color: '#404040',
                        fontStyle: 'normal',
                        fontWeight: 'normal',
                        fontFamily: 'Arial',
                        fontSize: 14,
                    },
                },
                yAxis: {
                    type: 'category',
                    /*name: 'Category',*/
                    data: stackData.axisTitle,
                    nameLocation: 'center',
                    axisLabel: {
                        show: true,
                        color: '#404040',
                        fontStyle: 'normal',
                        fontWeight: 'normal',
                        fontFamily: 'Arial',
                        fontSize: 14,
                    },

                },
                series: stackData.series.map(item => ({
                    name: item.name,
                    type: 'bar',
                    stack: 'total',  // 或用 item.name 來堆疊不同組
                    data: item.values,
                    label: {
                        show: true,
                        /*color: '#ff0000',*/
                        position: 'inside',
                        verticalAlign: 'middle',
                        /*offset: [8, 0]*/
                        formatter: function (params) {
                            return params.value === 0 ? '' : params.value;
                        }
                    }
                })),
                brush: {

                }
            });

            //const pieData2 = monthlyData.pieChart2;
            const pieData2 = monthlyData.pieChartDic['CostCode'];

            pieChart2.setOption({
                // 建立 pieData 的 option
                title: {
                    show: true,
                    text: pieData2.title,
                    top: '2%',
                    textStyle: {
                        fontSize: 14,
                        color: 'rgb(0, 0, 0)',
                        fontFamily: '微軟正黑體'
                    },
                    //subtext: 'subtext',
                    subtextStyle: {
                        fontSize: 16,
                        color: 'rgb(120, 120, 120)',
                        fontFamily: 'Arial'
                    }
                },
                tooltip: { trigger: 'item' },
                series: [{
                    name: 'name',
                    type: 'pie',
                    radius: ['20%', '45%'],
                    center: ['50%', '55%'], // [水平位置, 垂直位置]
                    data: pieData2.data,
                    label: {
                        show: true,
                        formatter: '{b}\n{c}({d}%)',
                        fontSize: 14
                    },
                    /*emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }*/
                }]
            });

        });
    }

</script>